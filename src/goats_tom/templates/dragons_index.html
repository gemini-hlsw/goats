{% extends "tom_common/base.html" %}
{% load static %}
{% block content %}
{% csrf_token %}

<!-- Modal -->
<div id="modalContainer"></div>

<div class="row g-3">
  <div class="col-12">
    <p class="h3">{{ observation_record.observation_id }}</p>
  </div>
</div>
<div class="row g-3">
  <div class="col-xl-5 col-lg-6 col-12">
    <div class="card" id="setupCard" data-observation-record-pk="{{ observation_record.id }}">
      <div class="card-header">
        DRAGONS Reduction Setup and Configure
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-12">
            <label class="form-label">Choose Run Type</label>
            <div class="btn-group d-flex" role="group" aria-label="Run Type Options">
              <input type="radio" name="runType" class="btn-check" id="useExistingRun" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="useExistingRun">Existing Run</label>
              <input type="radio" name="runType" class="btn-check" id="startNewRun" autocomplete="off">
              <label class="btn btn-outline-primary" for="startNewRun">New Run</label>
            </div>
          </div>
        </div>
        <form id="setupForm" method="post" class="d-none mb-3">
          <div class="row g-3">
            <input type="hidden" name="observation_record" value="{{ observation_record.pk }}">
            <div class="col-12">
              <label for="runId" class="form-label">Run ID</label>
              <input type="text" class="form-control" id="runId" name="run_id" placeholder="Default: run-YYYYMMDDhhmmss">
            </div>
            <div class="col-12">
              <label for="configFilename" class="form-label">Configuration File</label>
              <input type="text" class="form-control" id="configFilename" name="config_filename" value="dragonsrc">
            </div>
            <div class="col-12">
              <label for="calManagerFilename" class="form-label">Calibration Manager File</label>
              <input type="text" class="form-control" id="calManagerFilename" name="cal_manager_filename" value="cal_manager.db">
            </div>
            <div class="col-12">
              <button type="submit" class="btn d-block w-100 btn-primary">Create Run</button>
            </div>
          </div>
        </form>
        <div class="row g-3">
          <div class="col-12">
            <div class="input-group">
              <select class="form-select" id="runSelect">
                <option value="" selected hidden>Select a Run</option>
                {% for dragons_run in dragons_runs %}
                  <option value="{{ dragons_run.id }}">{{ dragons_run.run_id }}</option>
                {% endfor %}
              </select>
              <button disabled id="deleteRun" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i></button>
            </div>
          </div>
          <div class="col-12">
            <div id="filesContainer" class="accordion accordion-flush"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-7 col-lg-6 col-12">
    <div id="recipesContainer" class="row g-3"></div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/logger.js' %}"></script>
<script src="{% static 'js/get_csrf_token.js' %}"></script>
<script src="{% static 'js/fetch_wrapper.js' %}"></script>
<script src="{% static 'js/dragons_setup_mvc.js' %}"></script>
<script src="{% static 'js/recipe_mvc.js' %}"></script>
<script src="{% static 'js/recipes_manager_mvc.js' %}"></script>
<script src="{% static 'ace-builds/src-noconflict/ace.js' %}"></script>
<script src="{% static 'ace-builds/src-noconflict/mode-python.js' %}"></script>
<script src="{% static 'ace-builds/src-noconflict/theme-cloud9_night.js' %}"></script>
<script src="{% static 'ace-builds/src-noconflict/theme-dawn.js' %}"></script>
{% include 'tom_dataproducts/partials/js9_scripts.html' %}

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", async () => {
    const api = new FetchWrapper("/api/");
    api.setCsrfToken("{{ csrf_token }}");

    // Initialize models, views, and controllers.
    const setupModel = new SetupModel(api);
    const setupView = new SetupView();
    const setupController = new SetupController(setupModel, setupView);
    const recipeManagerModel = new RecipeManagerModel(api);
    const recipeManagerView = new RecipeManagerView();
    const recipeManagerController = new RecipeManagerController(recipeManagerModel, recipeManagerView);

    /**
     * Handles the change in run selection by fetching related files and updating recipe cards
     * accordingly.
     * @param {string} observationRecordPk The primary key of the observation record.
     * @param {string} runId The ID of the selected run to fetch files for and to display recipes.
     */
    const handleRunSelectionChange = async (observationRecordPk, runId) => {
      await setupController.handleFetchFiles(observationRecordPk, runId);
      await recipeManagerController.updateRecipeCards(runId);
      await recipeManagerController.updateReducesProgress(runId);
    };

    // Bind the combined functionality to the run selection change.
    setupView.bindFetchFiles(handleRunSelectionChange);
  });
</script>
{% endblock %}
