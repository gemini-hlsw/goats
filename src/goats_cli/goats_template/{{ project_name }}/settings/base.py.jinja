"""
Base settings for GOATS.

This file is maintained by GOATS.

It contains all Django and TOMToolkit/GOATS configuration that should update when
you upgrade versions of GOATS.

Do not modify this file â€” your changes will be overwritten on update.
Use generated.py for machine-specific values and local.py for local overrides.
"""

import tempfile
from pathlib import Path

import redis

from .dynamic import *
from .generated import *


BASE_DIR = Path(__file__).resolve().parent.parent.parent
"""Base directory of the project."""

DEBUG = True
"""Enable debug mode."""

ALLOWED_HOSTS = ["*"]
"""Allowed hosts for the Django application."""

TOM_NAME = "{{ project_name }}"
"""Name of the TOM instance."""

INSTALLED_APPS = [
    "django_dramatiq",
    "goats_scheduler",
    "daphne",
    "goats_tom",
    "channels",
    "corsheaders",
    "tom_tns",
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "django.contrib.sites",
    "django_extensions",
    "guardian",
    "tom_common",
    "django_comments",
    "bootstrap4",
    "crispy_bootstrap4",
    "crispy_forms",
    "rest_framework",
    "rest_framework.authtoken",
    "django_filters",
    "django_gravatar",
    "tom_targets",
    "tom_alerts",
    "tom_catalogs",
    "tom_observations",
    "tom_dataproducts",
]
"""List of installed Django applications."""

SITE_ID = 1
"""ID of the Django site."""

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "goats_tom.middleware.TNSCredentialsMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "tom_common.middleware.Raise403Middleware",
    "tom_common.middleware.ExternalServiceMiddleware",
    "tom_common.middleware.AuthStrategyMiddleware",
]
"""List of middleware classes."""

ROOT_URLCONF = "{{ project_name }}.urls"
"""Root URL configuration module."""

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [(BASE_DIR / "templates")],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
                "goats_tom.context_processors.goats_version_info_processor",
            ],
        },
    },
]
"""Template configuration."""

CRISPY_TEMPLATE_PACK = "bootstrap4"
"""Crispy forms template pack."""

WSGI_APPLICATION = "{{ project_name }}.wsgi.application"
"""WSGI application module."""

DATABASE_TIMEOUT = 20
"""Database timeout in seconds."""

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
        "OPTIONS": {"timeout": DATABASE_TIMEOUT },
    }
}
"""Database configuration."""

ASGI_APPLICATION = "{{ project_name }}.asgi.application"
"""ASGI application module."""

CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [(REDIS_HOST, REDIS_PORT)],
        },
    },
}
"""Channels layer configuration for websockets."""

DRAMATIQ_REDIS_URL = f"redis://{REDIS_HOST}:{REDIS_PORT}/1"
"""Redis URL for Dramatiq broker."""

DRAMATIQ_BROKER = {
    "BROKER": "dramatiq.brokers.redis.RedisBroker",
    "OPTIONS": {
        "connection_pool": redis.ConnectionPool.from_url(DRAMATIQ_REDIS_URL),
    },
    "MIDDLEWARE": [
        "dramatiq.middleware.AgeLimit",
        "dramatiq.middleware.TimeLimit",
        "dramatiq.middleware.Retries",
        "django_dramatiq.middleware.DbConnectionsMiddleware",
        "dramatiq.middleware.Callbacks",
        "goats_tom.middleware.DRAGONSMiddleware",
        # "django_dramatiq.middleware.AdminMiddleware",
        # Disabled the AdminMiddleware to avoid issues with database locks.
    ],
}
"""Dramatiq broker configuration."""

DRAMATIQ_ACTOR_TIME_LIMIT = 86400000
"""Time limit for Dramatiq actors in milliseconds."""

DRAMATIQ_AUTODISCOVER_MODULES = ["tasks"]
"""Modules to autodiscover for Dramatiq actors."""

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
    },
]
"""Password validation settings."""

LOGIN_URL = "/accounts/login/"
"""URL to redirect to for login."""

LOGIN_REDIRECT_URL = "/"
"""URL to redirect to after login."""

LOGOUT_REDIRECT_URL = "/"
"""URL to redirect to after logout."""

AUTHENTICATION_BACKENDS = (
    "django.contrib.auth.backends.ModelBackend",
    "guardian.backends.ObjectPermissionBackend",
)
"""Authentication backends."""

LANGUAGE_CODE = "en-us"
"""Language code."""

TIME_ZONE = "UTC"
"""Time zone."""

USE_I18N = True
"""Internationalization."""

USE_L10N = False
"""Localization."""

USE_TZ = True
"""Timezone support."""

DATETIME_FORMAT = "Y-m-d H:i:s"
"""Date and time format."""

DATE_FORMAT = "Y-m-d"
"""Date format."""

STATIC_URL = "/static/"
"""URL to use for static files."""

STATIC_ROOT = BASE_DIR / "_static"
"""Directory to collect static files to."""

STATICFILES_DIRS = [(BASE_DIR / "static")]
"""Additional directories for static files."""

MEDIA_URL = "/data/"
"""URL to use for media files."""

LOGGING = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "verbose": {
            "format": "{levelname} {asctime} {name} {filename}:{lineno} - {message}",
            "style": "{",
        },
        "simple": {
            "format": "{levelname} {message}",
            "style": "{",
        },
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "formatter": "simple",
        },
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "filename": BASE_DIR / "goats.log",
            "formatter": "verbose",
            "maxBytes": 1024 * 1024 * 50,  # 50 MB.
            "backupCount": 2,  # Keep two backup log files.
        },
    },
    "loggers": {
        "": {"handlers": ["console", "file"], "level": "INFO"},
        "goats_tom": {
            "handlers": ["console", "file"],
            "level": "DEBUG",
            "propagate": False,
        },
    },
}
"""Logging configuration. Logs to console and to goats.log file."""

CACHE_REDIS_URL = f"redis://{REDIS_HOST}:{REDIS_PORT}/2"
"""Redis URL for cache backend."""

CACHES = {
    "default": {
        "BACKEND": "django.core.cache.backends.filebased.FileBasedCache",
        "LOCATION": tempfile.gettempdir(),
    },
    "redis": {
        "BACKEND": "django.core.cache.backends.redis.RedisCache",
        "LOCATION": CACHE_REDIS_URL,
        "KEY_PREFIX": "goats",
        "TIMEOUT": None,
    },
}
"""Cache configuration."""

DEFAULT_AUTO_FIELD = "django.db.models.AutoField"
"""Default auto field type for Django models."""

DATA_PRODUCT_PATH = "goats_tom.utils.custom_data_product_path"
"""Function to determine data product storage path."""

FACILITIES = {
    "LCO": {
        "portal_url": "https://observe.lco.global",
    },
    "GEM": {
        "portal_url": {
            "GS": "https://139.229.34.15:8443",
            "GN": "https://128.171.88.221:8443",
        }
    },
}
"""Configuration for observatory facilities."""

DATA_PRODUCT_TYPES = {
    "photometry": ("photometry", "Photometry"),
    "fits_file": ("fits_file", "FITS File"),
    "spectroscopy": ("spectroscopy", "Spectroscopy"),
    "image_file": ("image_file", "Image File"),
}
"""Types of data products."""

DATA_PROCESSORS = {
    "photometry": "tom_dataproducts.processors.photometry_processor.PhotometryProcessor",
    "spectroscopy": "goats_tom.processors.spectroscopy_processor.SpectroscopyProcessor",
}
"""Data processors for different data product types."""

TOM_FACILITY_CLASSES = [
    "goats_tom.facilities.GOATSGEMFacility",
    "goats_tom.facilities.LCOFacility",
    "goats_tom.facilities.SOARFacility",
]
"""Classes for observatory facilities."""

TOM_ALERT_CLASSES = [
    "goats_tom.brokers.ANTARESBroker",
    "tom_alerts.brokers.alerce.ALeRCEBroker",
    "tom_alerts.brokers.gaia.GaiaBroker",
    "tom_alerts.brokers.scout.ScoutBroker",
]
"""Classes for alert brokers."""

BROKERS = {
    "TNS": {
        "api_key": "",
        "bot_id": "",
        "bot_name": "",
        "tns_base_url": "https://www.wis-tns.org/",
        "group_names": [],
        "filter_mapping": {},
        "instrument_mapping": {},
        "default_authors": "",
    }
}
"""Configuration for alert brokers."""

TOM_HARVESTER_CLASSES = [
    "tom_catalogs.harvesters.simbad.SimbadHarvester",
    "tom_catalogs.harvesters.ned.NEDHarvester",
    "tom_catalogs.harvesters.jplhorizons.JPLHorizonsHarvester",
    "goats_tom.harvesters.tns.TNSHarvester",
]
"""Classes for catalog harvesters."""

HARVESTERS = {"TNS": {"api_key": ""}}
"""Configuration for catalog harvesters."""

EXTRA_FIELDS = []
"""List of extra fields to add to target model."""

AUTH_STRATEGY = "READ_ONLY"
"""Authentication strategy for the TOM. Can either be LOCKED (required login for all
views) or READ_ONLY (read only access to views)."""

TARGET_PERMISSIONS_ONLY = True
"""Row-level data permission setting. Row-level data permissions restrict users from
viewing certain objects unless they are a member of the group to which the object
belongs. Setting this value to True will allow all ``ObservationRecord``,
``DataProduct``, and ``ReducedDatum`` objects to be seen by everyone. Setting it to
``False`` will allow users to specify which groups can access ``ObservationRecord``,
``DataProduct``, and ``ReducedDatum`` objects"""

OPEN_URLS = []
"""List of URLs that are open even when AUTH_STRATEGY is LOCKED."""

HOOKS = {
    "target_post_save": "tom_common.hooks.target_post_save",
    "observation_change_state": "tom_common.hooks.observation_change_state",
    "data_product_post_upload": "tom_dataproducts.hooks.data_product_post_upload",
    "data_product_post_save": "tom_dataproducts.hooks.data_product_post_save",
    "multiple_data_products_post_save": "tom_dataproducts.hooks.multiple_data_products_post_save",
}
"""Hook functions for various events."""

AUTO_THUMBNAILS = False
"""Enable automatic thumbnail generation for uploaded images."""

THUMBNAIL_MAX_SIZE = (0, 0)
"""Maximum size for generated thumbnails."""

THUMBNAIL_DEFAULT_SIZE = (200, 200)
"""Default size for generated thumbnails."""

HINT_LEVEL = 20
"""Level of hints to display in the UI."""

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework.authentication.SessionAuthentication",
        "rest_framework.authentication.TokenAuthentication",
    ),
    "DEFAULT_PERMISSION_CLASSES": [],
    "TEST_REQUEST_DEFAULT_FORMAT": "json",
    "DEFAULT_PAGINATION_CLASS": "rest_framework.pagination.LimitOffsetPagination",
    "PAGE_SIZE": 100,
    "DEFAULT_FILTER_BACKENDS": ["django_filters.rest_framework.DjangoFilterBackend"],
}
"""Django REST Framework configuration."""

CORS_ORIGIN_REGEX_WHITELIST = [
    r"^chrome-extension://[a-zA-Z0-9-]+$",
    r"^moz-extension://[a-zA-Z0-9-]+$",
]
"""CORS origin whitelist for browser extensions."""

PLOTLY_THEME = "plotly_dark"
"""Default Plotly theme setting. Can be set to any valid theme: 'plotly',
'plotly_white', 'plotly_dark', 'ggplot2', 'seaborn', 'simple_white', 'none'."""

# Setting for displaying pagination information (e.g., "(0-0 of 0)").
# Set this to False if you have a particularly large DB and paginated views are slow.
SHOW_PAGINATION_INFO = True
"""Enable or disable display of pagination information (e.g., "(0-0 of 0)") in the UI.
Set to ``False`` if you have a particularly large database and paginated views are
slow."""

# Set the GPP environment (DEVELOPMENT, STAGING, or PRODUCTION)
GPP_ENV = "PRODUCTION"
"""Environment setting for the GOATS Pipeline Platform (GPP). Can be set to
``DEVELOPMENT``, ``STAGING``, or ``PRODUCTION``."""
